# Supabase Maintenance Automation
# Run via GitHub Actions weekly (Sunday 2 AM EST)

name: Supabase Weekly Maintenance

on:
  schedule:
    # Every Sunday at 2 AM EST (7 AM UTC)
    - cron: '0 7 * * 0'
  workflow_dispatch:

jobs:
  maintenance:
    name: Supabase Maintenance & Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token -
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Check migration status
        run: |
          supabase db remote commit --dry-run || echo "No pending migrations"

      - name: Create database backup
        run: |
          supabase db dump -f backup-$(date +%Y%m%d).sql
          mkdir -p ops/dashboards/backups
          mv backup-*.sql ops/dashboards/backups/
        continue-on-error: true

      - name: Run database maintenance
        run: |
          # Vacuum and analyze
          supabase db execute --sql "VACUUM ANALYZE;"
          
          # Check for long-running queries
          supabase db execute --sql "
            SELECT pid, now() - pg_stat_activity.query_start AS duration, query 
            FROM pg_stat_activity 
            WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes';
          "
        continue-on-error: true

      - name: Generate maintenance report
        run: |
          cat > ops/dashboards/reports/maintenance-$(date +%Y%m%d).md << EOF
          # Supabase Maintenance Report
          Date: $(date +%Y-%m-%d)
          
          ## Backup Status
          - Backup created: backup-$(date +%Y%m%d).sql
          
          ## Database Health
          - Last maintenance: $(date)
          - Next maintenance: $(date -d '+7 days')
          
          ## Performance Metrics
          - Database size: Check Supabase dashboard
          - Active connections: Check Supabase dashboard
          
          EOF

      - name: Upload backup to artifact storage
        uses: actions/upload-artifact@v5
        with:
          name: supabase-backup-$(date +%Y%m%d)
          path: ops/dashboards/backups/backup-*.sql
          retention-days: 30

      - name: Commit maintenance report
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add ops/dashboards/reports/maintenance-*.md
          git commit -m "ops(auto): weekly Supabase maintenance report $(date +%Y%m%d)" || exit 0
          git push || echo "No changes to commit"
        continue-on-error: true

      - name: Notification
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âœ… Supabase weekly maintenance completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Supabase Maintenance Complete*\n\nDate: $(date +%Y-%m-%d)\nBackup: Created\nStatus: Success"
                  }
                }
              ]
            }
        continue-on-error: true
