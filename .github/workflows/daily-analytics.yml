# Daily Analytics Script Runner
# Runs daily at 9 AM EST, generates reports and commits to repo

name: Daily Analytics & Report Generation

on:
  schedule:
    # Every day at 9 AM EST (14:00 UTC)
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  analytics:
    name: Generate Analytics Reports
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run analytics scripts
        run: |
          mkdir -p ops/dashboards/reports
          
          # Generate marketing analytics
          node scripts/analytics-marketing.js > ops/dashboards/reports/marketing-$(date +%Y%m%d).csv || echo "Marketing analytics script not found, skipping"
          
          # Generate finance analytics
          node scripts/analytics-finance.js > ops/dashboards/reports/finance-$(date +%Y%m%d).csv || echo "Finance analytics script not found, skipping"
          
          # Generate KPI summary
          node scripts/analytics-kpi.js > ops/dashboards/reports/kpi-$(date +%Y%m%d).json || echo "KPI analytics script not found, skipping"
          
          # Generate markdown summary
          cat > ops/dashboards/reports/daily-summary-$(date +%Y%m%d).md << EOF
          # Daily Analytics Summary
          Date: $(date +%Y-%m-%d)
          
          ## Marketing Metrics
          - See: marketing-$(date +%Y%m%d).csv
          
          ## Finance Metrics (CAD)
          - See: finance-$(date +%Y%m%d).csv
          
          ## KPI Summary
          - See: kpi-$(date +%Y%m%d).json
          
          Generated automatically by GitHub Actions
          EOF
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

      - name: Commit reports
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add ops/dashboards/reports/
          git commit -m "ops(auto): daily analytics report $(date +%Y%m%d)" || exit 0
          git push || echo "No changes to commit"
        continue-on-error: true

      - name: Upload reports as artifact
        uses: actions/upload-artifact@v5
        with:
          name: daily-analytics-$(date +%Y%m%d)
          path: ops/dashboards/reports/*
          retention-days: 90
