name: Nightly ETL
on:
  schedule:
    - cron: '10 1 * * *'  # 01:10 America/Toronto
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install deps
        run: npm ci || true
      - name: Run ETL
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}
          META_TOKEN: ${{ secrets.META_TOKEN }}
          META_AD_ACCOUNT_ID: ${{ secrets.META_AD_ACCOUNT_ID }}
          TIKTOK_TOKEN: ${{ secrets.TIKTOK_TOKEN }}
          TIKTOK_ADVERTISER_ID: ${{ secrets.TIKTOK_ADVERTISER_ID }}
          SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY }}
          SHOPIFY_PASSWORD: ${{ secrets.SHOPIFY_PASSWORD }}
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          TZ: America/Toronto
        run: |
          node scripts/etl/pull_ads_meta.ts || echo "Meta ETL failed"
          node scripts/etl/pull_ads_tiktok.ts || echo "TikTok ETL failed"
          node scripts/etl/pull_shopify_orders.ts || echo "Shopify ETL failed"
          node scripts/etl/compute_metrics.ts --cron || echo "Metrics computation failed"
